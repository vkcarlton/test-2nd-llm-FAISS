name: Deploy to Raspberry Pi

# Trigger on pushes to main (or whichever branch)
on:
  push:
    branches:
      - main

jobs:
  deploy:
    # Use your self-hosted runner
    runs-on: self-hosted

    steps:
      # 1. Checkout the repo
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. Load environment variables from .env
      - name: Load .env
        run: |
          if [ -f .env ]; then
            export $(grep -v '^#' .env | xargs)
          fi

      # 3. Build and start Docker Compose
      - name: Build and run Docker Compose
        run: |
          if [ "$USE_GPU" = "true" ]; then
            docker compose -f docker-compose.gpu.yml up --build -d
          else
            docker compose -f docker-compose.yml up --build -d
          fi

      # 4. Optional: prune old Docker images to save space
      - name: Docker prune
        run: docker system prune -f
